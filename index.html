<html>
<head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
</head>
<script>
var ciphertext = decodeURI("%ciphertext%");

var JsonFormatter = {
	// this block copypastas from https://code.google.com/p/crypto-js/#The_Cipher_Output
        stringify: function (cipherParams) {
            // create json object with ciphertext
            var jsonObj = {
                ct: cipherParams.ciphertext.toString(CryptoJS.enc.Base64)
            };

            // optionally add iv and salt
            if (cipherParams.iv) {
                jsonObj.iv = cipherParams.iv.toString();
            }
            if (cipherParams.salt) {
                jsonObj.s = cipherParams.salt.toString();
            }

            // stringify json object
            return JSON.stringify(jsonObj);
        },

        parse: function (jsonStr) {
            // parse json string
            var jsonObj = JSON.parse(jsonStr);

            // extract ciphertext from json object, and create cipher params object
            var cipherParams = CryptoJS.lib.CipherParams.create({
                ciphertext: CryptoJS.enc.Base64.parse(jsonObj.ct)
            });

            // optionally extract iv and salt
            if (jsonObj.iv) {
                cipherParams.iv = CryptoJS.enc.Hex.parse(jsonObj.iv)
            }
            if (jsonObj.s) {
                cipherParams.salt = CryptoJS.enc.Hex.parse(jsonObj.s)
            }

            return cipherParams;
        }
    };

function decrypt() {
	var password = $("#password-div input[type=password]")[0].value;
	console.log("\"" + ciphertext + "\"");
	var decrypted = CryptoJS.AES.decrypt(ciphertext,password,{format:JsonFormatter});
	$("#save-div textarea")[0].innerHTML = decrypted.toString(CryptoJS.enc.Utf8);
	$("#password-div")[0].style.display = "none";
	$("#save-div")[0].style.display = "block";
}

function save() {
	var newCleartext = $("#save-div textarea")[0].value;
	var password = null;
	if(ciphertext == "") {
		password = $("#new-pass input[type=text]")[0].value;
	} else {
		password = $("#password-div input[type=password]")[0].value;
	}
	console.log(password);
	var newCiphertext = encodeURI(CryptoJS.AES.encrypt(newCleartext,password,{format:JsonFormatter}).toString());
	console.log(newCiphertext)
	$.ajax({
		url:	window.location.href,
		dataType: "json",
		type: "PUT",
		data: newCiphertext,
		success: function(data,status,req) {
			console.log("success\t" + req);
		},
		error:	function(req,status,err) {
			console.log("error\t" + status);
		}
	});
}

$(document).ready(function() {
	if(ciphertext == "") {
		$("#password-div")[0].style.display = "none";
		
		$("#save-div")[0].style.display = "block";
		$("#new-pass")[0].style.display = "block";
	}
});
</script>
<style>
#save-div {
	display: none;
}
</style>
<body>
<div id="password-div">
<p>Enter password: <input type="password"> <input type="button" value="Decrypt" onclick="decrypt()"></p>
</div>
<div id="save-div">
<div id="new-pass" style="display:none;">New pass: <input type="text"></input></div><input type="button" value="Save" onclick="save()">
<textarea></textarea>
</div>
</body>
</html>
